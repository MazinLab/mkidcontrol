{% extends 'base.html' %}

{% block content %}
    {{ super() }}

    <div class="container-fluid">
        <div class="flex-row">
            <main role="main" class="col-10">
                <div class="d-flex justify-content-center align-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                    <div class="flex-column col-4">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <h2>Observation Control</h2>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <form method="post">
                                {% for field in obsform %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Observation Info</h2>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Target: None
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Count Rate: 0.0
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Exposure Time: 00:00
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                SNR Est: 0.0
                            </div>
                        </div>
                    </div>

                    <div class="flex-column col-4 border-left">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Dash</h2>
                        </div>
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="dash"></div>
                        </div>
                    </div>

                    <div class="flex-column col-4 border-left">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Fridge Control</h2>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <form method="post">
                                {% for field in magnetform %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <form method="post">
                                {% for field in schedule %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <h4>Heatswitch</h4>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            {{ render_form(hsform) }}
                        </div>
                    </div>
                </div>


                <div class="d-flex justify-content-center align-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                    <div class="flex-column col-6">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <h4>Device Plots!</h4>
                        </div>
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="indexplot"></div>
                        </div>
                    </div>
                    <div class="flex-column col-6 border-left">
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="pixel_lightcurve"></div>
                        </div>
                        <div id="stopper" class="column" style="float: left; margin-left: 50%; width: 20%">
                            <button onclick="delete_pixel_lightcurve_trace()">Stop</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        Plotly.react('dash', {{ dd | safe}}, {{ dl | safe }}, {{ dc | safe}})
        Plotly.newPlot('indexplot', {{ d | safe }}, {{ l | safe }}, {{ c | safe}})
        initialize_lightcurve()

        function update_index_page() {
            var source = new EventSource("/listener");
            source.addEventListener("message", function (e) {
                var newdata = JSON.parse(e.data);

                var j;
                var k = {{ sensorkeys | safe }};
                for (j=0; j<k.length; j++) {
                    update_plot("indexplot", k[j], newdata, j);
                }
            }, false);
            source.addEventListener("open", function (e) {
                console.log('Connection was opened: ', e);
            }, false);
            source.addEventListener("error", function (e) {
                console.log("Connection errored out: ", e);
            }, false);
        }
        update_index_page()

        var pixel;
        var array_update_time;
        function update_array_viewer() {
            pixel = [-1, -1];
            var source = new EventSource("/dashlistener");
            source.addEventListener("message", function (e) {
                var newdata = JSON.parse(e.data);
                var array_data = JSON.parse(newdata['data'])
                Plotly.react('dash', array_data, {{ dl | safe }})
                console.log(pixel)

                array_update_time = newdata['time'];
                if (pixel[0] != -1 && pixel[1] != -1) {
                    Plotly.extendTraces('pixel_lightcurve', {x:[[array_update_time]], y:[[array_data[0].z[pixel[1]][pixel[0]]]]}, [0])
                }
            }, false);
            source.addEventListener("open", function (e) {
                console.log('Connection was opened: ', e);
            }, false);
            source.addEventListener("error", function (e) {
                console.log("Connection errored out: ", e);
            }, false);
        }
        update_array_viewer()

        var myPlot = document.getElementById('dash');

        function delete_pixel_lightcurve_trace(){
            pixel = [-1, -1]
            Plotly.deleteTraces('pixel_lightcurve', 0);
            initialize_lightcurve()
        };

        function initialize_lightcurve(time=0, cts=0, p=[-1,-1]){
            if (p[0] != -1) {
                Plotly.newPlot('pixel_lightcurve', [{x:[time], y:[cts], type:'scatter'}], {title:"Pixel ("+p[0]+", "+p[1]+") Light Curve"}, {'responsive': true})
            }
            else {
                Plotly.newPlot('pixel_lightcurve', [{x:[time], y:[cts], type:'scatter'}], {title:"Pixel Light Curve"}, {'responsive': true})
            }

        };

        myPlot.on('plotly_click', function(data){
            delete_pixel_lightcurve_trace()
            console.log("value at ("+data.points[0].x+", "+data.points[0].y+") is "+Number(data.points[0].z).toFixed(2)+" cts/s")
            pixel = [data.points[0].x, data.points[0].y]
            initialize_lightcurve(array_update_time, Number(data.points[0].z).toFixed(2), pixel);
        })

    </script>

{% endblock %}