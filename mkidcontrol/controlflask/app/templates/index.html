{% extends 'base.html' %}

{% block content %}
    {{ super() }}

    <div class="container-fluid">
        <div class="flex-row">
            <main role="main" class="col-10">
                <div class="d-flex justify-content-center align-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                    <div class="flex-column col-4">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <form method="post">
                                {% for field in obsform %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Observation Info</h2>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Target: None
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Count Rate: 0.0
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                Exposure Time: 00:00
                            </div>
                            <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                SNR Est: 0.0
                            </div>
                        </div>
                    </div>

                    <div class="flex-column col-4 border-left">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Array View</h2>
                        </div>
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="dash"></div>
                        </div>
                    </div>

                    <div class="flex-column col-4 border-left">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <h2>Fridge Control</h2>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <form method="post">
                                {% for field in magnetform %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            <form method="post">
                                {% for field in schedule %}
                                <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-1 mb-1">
                                    {{ render_field(field)}}
                                </div>
                                {% endfor %}
                            </form>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <h4>Heatswitch</h4>
                        </div>
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                            {{ render_form(hsform) }}
                        </div>
                    </div>
                </div>


                <div class="d-flex justify-content-center align-content-center flex-wrap flex-md-nowrap py-2 mb-3 border-bottom">
                    <div class="flex-column col-6">
                        <div class="d-flex justify-content-center flex-wrap flex-md-nowrap py-2 mb-3">
                            <h4>Sensor Plots</h4>
                        </div>
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="indexplot"></div>
                        </div>
                    </div>
                    <div class="flex-column col-6 border-left">
                        <div class="flex-column flex-wrap flex-md-nowrap py-2 mb-3">
                            <div id="pixel_lightcurve"></div>
                        </div>
                        <div id="stopper" class="column" style="float: left; margin-left: 50%; width: 20%">
                            <button onclick="delete_pixel_lightcurve_trace()">Stop</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        var sensorfig = {{ sensor_fig | safe }};
        Plotly.react('indexplot', sensorfig)

        var arrayfig = {{ array_fig | safe }};
        Plotly.react('dash', arrayfig)

        var lightcurve_init = {{ pix_lightcurve | safe }};
        Plotly.react('pixel_lightcurve', lightcurve_init)

        var rediskeys = {{ sensorkeys | safe }};
        var pixel = [-1, -1];
        var array_update_time;

        var psource = new EventSource('{{ url_for("main.dashplot") }}');
        psource.addEventListener("dashplot", function (event) {
            var update = JSON.parse(event.data);
            var elem = document.getElementById(update['id']);
            var data = JSON.parse(update['data']);
            array_update_time = update['time'];
            if (elem) {
                switch (update['kind']) {
                    case "full":
                        Plotly.react(update['id'], data);
                        break;
                    case "partial":
                        Plotly.extendTraces(update['id'], {z: [data.data[0]['z']]});
                        break;
                }
            }
            if (pixel[0] != -1 && pixel[1] != -1) {
                Plotly.extendTraces('pixel_lightcurve', {x:[[update['time']]], y:[[data.data[0]['z'][pixel[1]][pixel[0]]]]}, [0])
            }
        }, false);
        psource.addEventListener("open", function (e) {console.log('Connection was opened: ', e);}, false);
        psource.addEventListener("error", function (e) {console.log("Connection errored out: ", e);}, false);

        function delete_pixel_lightcurve_trace(){
            pixel = [-1, -1]
            Plotly.deleteTraces('pixel_lightcurve', 0);
            Plotly.react('pixel_lightcurve', lightcurve_init)
        };

        var myPlot = document.getElementById('dash');
        myPlot.on('plotly_click', function(data){
            delete_pixel_lightcurve_trace()
            console.log("value at ("+data.points[0].x+", "+data.points[0].y+") is "+Number(data.points[0].z).toFixed(2)+" cts/s")
            pixel = [data.points[0].x, data.points[0].y]
            $.ajax({
                    type:'POST',
                    url:"{{ url_for('main.pixel_lightcurve') }}",
                    data: {
                        init: 0,
                        time: array_update_time,
                        cts: Number(data.points[0].z).toFixed(2),
                        pix_x: data.points[0].x,
                        pix_y: data.points[0].y
                    },
                    success:function(d){
                        Plotly.react('pixel_lightcurve', JSON.parse(d))
                    }
                })
        })

        var source = new EventSource("/listener");
        source.addEventListener("message", function (e) {
            var newdata = JSON.parse(e.data);

            for (let j=0; j<rediskeys.length; j++) {
                update_plot("indexplot", rediskeys[j], newdata, j);
            }
        }, false);
        source.addEventListener("open", function (e) {console.log('Connection was opened: ', e);}, false);
        source.addEventListener("error", function (e) {console.log("Connection errored out: ", e);}, false);

    </script>

{% endblock %}