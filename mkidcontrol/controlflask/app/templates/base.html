{% extends 'base_bootstrap.html' %}
{% from 'bootstrap4/form.html' import render_form, render_field %}
{% from 'bootstrap4/nav.html' import render_nav_item %}

{% block title %}
  {% if title %}{{ title }} - MagAO-X KID Camera{% else %}MKID Camera Control{% endif %}
{% endblock %}

{% block navbar %}
<!--    TODO: Make navbar? Or improve current navbar-->
{% endblock %}

{% block content %}
    {{ super() }}
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ moment.include_moment(local_js=url_for('static', filename='js/moment-with-locales.min.js')) }}
    {{ moment.lang(g.locale) }}
    <script src="{{ url_for('static', filename='js/tempusdominus-bootstrap-4.min.js') }}"></script>

    <script>
        function update_base_page() {
            var source = new EventSource("/listener");
            source.addEventListener("message", function (e) {
                var newdata = JSON.parse(e.data);
                // console.log("Message: ", newdata);
                update_div("50K_Temp", "status:temps:77k-stage:temp", newdata, true);
                update_div("3K_Temp", "status:temps:4k-stage:temp", newdata, true);
                update_div("1K_Temp", "status:temps:1k-stage:temp", newdata, true);
                update_div("Temp_Report", "status:temps:device-stage:temp", newdata, true);
                update_div("Meas_Current", "status:magnet:current", newdata, true);
                update_div("Magnet_Status", "status:magnet:state", newdata);
                update_div("heatswitch", "device-settings:currentduino:heatswitch", newdata);
                update_div("Hemt1Vd", "status:feedline1:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt2Vd", "status:feedline2:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt3Vd", "status:feedline3:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt4Vd", "status:feedline4:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt5Vd", "status:feedline5:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt1Vg", "status:feedline1:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt2Vg", "status:feedline2:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt3Vg", "status:feedline3:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt4Vg", "status:feedline4:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt5Vg", "status:feedline5:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt1Id", "status:feedline1:hemt:drain-current-bias", newdata, true);
                update_div("Hemt2Id", "status:feedline2:hemt:drain-current-bias", newdata, true);
                update_div("Hemt3Id", "status:feedline3:hemt:drain-current-bias", newdata, true);
                update_div("Hemt4Id", "status:feedline4:hemt:drain-current-bias", newdata, true);
                update_div("Hemt5Id", "status:feedline5:hemt:drain-current-bias", newdata, true);
            }, false);
            source.addEventListener("open", function (e) {
                console.log('Connection was opened: ', e);
            }, false);
            source.addEventListener("error", function (e) {
                console.log("Connection errored out: ", e);
            }, false);
        };
        update_base_page()

        function update_div(div, key, sentdata, ts=false) {
            var data = sentdata[key];
            if (ts) {
                var time = data[2];
                var value = Number(data[1]).toFixed(3);
            } else {
                var value = data;
            }
            $("#"+div).text(value)
        };

        function update_plot(div, key, sentdata, trace=0) {
            var data = sentdata[key];
            var time = data[2];
            var value = data[1];
            Plotly.extendTraces(div, {x:[[time]], y:[[value]]}, [trace])
        }

        function realtime_validate(id) {
            $("#"+id).keyup(function () {
                var text = $(this).val();
                $.ajax({
                    type:'POST',
                    url:'/validatecmd',
                    data:{
                        id:id,
                        data:text
                    },
                    success:function(d){
                        $("#"+id+"_success").text(d['legal'][1]);
                        if (d['legal'][0] == false) {
                            document.getElementById(id).style.color = 'red'
                        } else {
                            document.getElementById(id).style.color = 'blue'
                        }
                        console.log(d);
                    }
                })
            })
        }

        function subdata(id, url) {
            $(document).on('submit', "#"+id+"_form", function(e){
               e.preventDefault();
               $.ajax({
                   type:'POST',
                   url:url,
                   data:{
                       id:id,
                       data:$("#"+id).val()
                   },
                   success:function(d)
                   {
                       $("#"+id+"_success").text(d['legal'][1])
                       if (d['legal'][0] == false) {
                            document.getElementById(id).style.color = 'red'
                        } else {
                            document.getElementById(id).style.color = 'blue'
                        }
                        if (d['cycle'] == true) {
                            var msg;
                            console.log(d['key'])
                            if (d['key'] == 'command:get-cold'){
                                msg = "Started cooldown at: ";
                            } else if (d['key'] == 'command:abort-cooldown') {
                                msg = "Cooldown aborted at: ";
                            } else if (d['key'] == 'command:cancel-scheduled-cooldown') {
                                msg = "Canceled previously scheduled cooldown at: ";
                            } else if (d['key'] == 'command:be-cold-at') {
                                if (d['legal'][0] == true) {
                                    msg = "Scheduling cooldown for: ";
                                } else {
                                    msg = "ILLEGAL TIME OR FORMAT! Cannot schedule cooldown for: ";
                                }
                            }
                            $("#ButtonData").text(msg+d['value'])
                        }
                       console.log(d);
                   }
               })
            });
        }

        function register_realtime_validation(keys) {
            var i;
            var k = keys;
            for (i=0; i < k.length; i++) {
                realtime_validate(k[i])
            }
        }

        function register_submitters(keys, url) {
            var i;
            var k = keys;
            for (i=0; i < k.length; i++) {
                subdata(k[i], url)
            }
        }

        function update_multiple_divs(id_and_redis_names, data) {
            var i;
            var keys = id_and_redis_names;
            for (i=0; i < keys.length; i++) {
                update_div(keys[i][0]+"_currentval", keys[i][1], data);
            }
        }
    </script>
{% endblock%}
