{% extends 'base.html' %}

{% block body %}
    {{ super() }}
    <script type="text/javascript">
        function newdata(key, title, typ) {
                var update = [];
                $.ajax({
                    url:'/sensor_plot/'+key+'/'+title+'/'+typ,
                    type: 'post',
                    async: false,
                    success: function(data) {
                        update = JSON.parse(data)
                        console.log('updated!')
                    },
                    error: function() {
                        console.log('New data could not be obtained')
                    }
                });
                return update;
            }
    </script>

    <script type="text/javascript">
        $(function() {
            $('a#test').on('click', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/start_cooldown',
                    type: 'post',
                    async: false,
                    success: function (data) {
                        console.log(data, data['msg'])
                        $("#dest").text(data['msg'])
                        $("#dest2").text('')
                        $("#dest3").text('')
                        $("#dest4").text('')
                    },
                    error: function () {
                    }
                });
            });
            $('a#test2').on('click', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/abort_cooldown',
                    type: 'post',
                    async: false,
                    success: function (data) {
                        console.log(data, data['msg'])
                        $("#dest2").text(data['msg'])
                        $("#dest").text('')
                        $("#dest3").text('')
                        $("#dest4").text('')
                    },
                    error: function () {
                    }
                });
            });
            $('a#test3').on('click', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/cancel_scheduled_cooldown',
                    type: 'post',
                    async: false,
                    success: function (data) {
                        console.log(data, data['msg'])
                        $("#dest3").text(data['msg'])
                        $("#dest").text('')
                        $("#dest2").text('')
                        $("#dest4").text('')
                    },
                    error: function () {
                    }
                });
            });
            $('a#test4').on('click', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/schedule_be_cold_at',
                    type: 'post',
                    data: {'time': $('#be_cold_time')[0].value},
                    async: false,
                    success: function (data) {
                        console.log(data, data['msg'])
                        $("#dest4").text(data['msg'])
                        $("#dest").text('')
                        $("#dest2").text('')
                        $("#dest3").text('')
                    },
                    error: function () {
                        console.log('failure')
                    }
                });
            });
        });
    </script>

    <div style="float:left; width:1500px; height:500px; margin-left: 250px">
        <div id="device_temp" style="float:left;width:450px;height:450px"></div>
        <div id="desired_magnet_current" style="float:left;width:450px;height:450px"></div>
        <div id="magnet_current" style="float:left;width:450px;height:450px"></div>
        <script>
            Plotly.newPlot('device_temp', {{ init_devt_d | safe }}, {{ init_devt_l | safe }})
            Plotly.newPlot('magnet_current', {{ init_magc_d | safe }}, {{ init_magc_l | safe }})
            Plotly.newPlot('desired_magnet_current', {{ init_smagc_d | safe }}, {{ init_smagc_l | safe }})
        </script>
    </div>

    <div style="width:1000px; height:500px; margin-left: 250px">
        <div id="lhe" style="float:left;width:450px;height:450px"></div>
        <div id="ln2" style="float:left;width:450px;height:450px"></div>
        <script>
            Plotly.newPlot('lhe', {{ init_lhe_d | safe }}, {{ init_lhe_l | safe }})
            Plotly.newPlot('ln2', {{ init_ln2_d | safe }}, {{ init_ln2_l | safe }})
        </script>
    </div>

    <div style="float:left; margin-left: 250px">
        <h1 style="padding:15px">Magnet Commands</h1>

        <div style="padding:15px">
            <a href="#" id="test" style="float:left">{{ form.start_cooldown() }}</a>
            <div id="dest" style="float:left"></div>
        </div>

        <div style="padding:15px">
            <a href="#" id="test2" style="float:left">{{ form.abort_cooldown() }}</a>
            <div id="dest2" style="float:left"></div>
        </div>

        <div style="padding:15px">
            <div><div style="float:left" id="t2">{{ form.be_cold_time.label }} {{ form.be_cold_time() }}</div><div style="float:left"><a href="#" id="test4" style="float:left">{{ form.schedule_cooldown() }}</a></div></div>
            <div id="dest4"></div>
            <a href="#" id="test3" style="float:left">{{ form.cancel_scheduled() }}</a>
            <div id="dest3"></div>
        </div>
    </div>

    <script>
        function ud_base() {
            console.log('INDEX UPDATER STARTED')
            var source = new EventSource("/listener");
            source.addEventListener("message", function (e) {
                var newdata = JSON.parse(e.data);
                console.log("Message: ", newdata);
                update_div("lhe", "status:temps:lhetank", newdata, true, true);
                update_div("ln2", "status:temps:ln2tank", newdata, true, true);
                update_div("device_temp", "status:temps:mkidarray:temp", newdata, true, true);
                update_div("desired_magnet_current", "status:device:sim960:current-setpoint", newdata, true, true);
                update_div("magnet_current", "status:highcurrentboard:current", newdata, true, true);
            }, false);
            source.addEventListener("open", function (e) {
                console.log('Connection was opened: ', e);
            }, false);
            source.addEventListener("error", function (e) {
                console.log("Connection errored out: ", e);
            }, false);
        };
        ud_base()
    </script>

{% endblock %}